#!/bin/bash

local summary="$1"

# Validate required summary parameter
if [[ -z "$summary" ]]; then
    echo "âŒ Usage: update_mr '<summary of changes>'"
    echo "ğŸ’¡ Tip: Run getDiff first, then call this with Claude's summary"
    return 1
fi

# Validate git repository
if ! git rev-parse --show-toplevel >/dev/null 2>&1; then
    echo "âŒ Not in a git repository"
    return 1
fi

local current_branch=$(git branch --show-current)
echo "ğŸ” Looking for MR for branch: $current_branch"

# Find MR for current branch using JSON output for reliable parsing
local mr_output=$(glab mr list --source-branch="$current_branch" --output json 2>/dev/null)

if [[ -z "$mr_output" ]] || [[ "$mr_output" == "[]" ]]; then
    echo "âŒ No open MR found for branch '$current_branch'"
    echo "ğŸ’¡ Create MR first: glab mr create"
    return 1
fi

# Extract MR ID from JSON
local mr_id=$(echo "$mr_output" | jq -r '.[0].iid // empty' 2>/dev/null)

if [[ -z "$mr_id" ]]; then
    echo "âŒ Could not extract MR ID from glab output"
    echo "ğŸ› Debug output:"
    echo "$mr_output"
    return 1
fi

echo "ğŸ“ Found MR !$mr_id"
echo "ğŸ”„ Updating description..."

# Update MR description
if glab mr update "$mr_id" --description "$summary" 2>/dev/null; then
    echo "âœ… Successfully updated MR !$mr_id"
    echo "ğŸ”— View: glab mr view $mr_id --web"
else
    echo "âŒ Failed to update MR description"
    return 1
fi